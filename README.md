---

# Adaptive OpenMP Scheduler

이 프로젝트는 GCC OpenMP 라이브러리(즉, libgomp)를 수정하여, 병렬 영역 실행 시 동적 프로파일링 데이터를 수집하고, 이를 기반으로 GSCHED 데몬과 통신을 통해 성능 기반 스케줄링 결정을 반영하는 시스템을 구현하는 것을 목적으로 합니다.

## 개요

- **목적:**  
  - OpenMP 병렬 영역 내에서 PCM과 Linux perf를 사용하여 여러 후보 스레드 구성(예: 4, 8, 16, 32, 64, 128, 256)에 대한 프로파일링 데이터를 수집합니다.
  - 수집된 데이터를 GSCHED 데몬에 전송하여, 전체 시스템의 캐시 미스율, 메모리 대역폭, FLOPS, 그리고 throughput 정보를 기반으로 각 OMP 태스크에 대해 최적의 스레드 개수 및 코어 배치를 결정합니다.
  - 결정된 스케줄링 정보를 이용하여 최종 병렬 영역을 실행함으로써, 각 태스크가 독립적으로 최적의 성능을 내도록 합니다.

- **구현 방식:**  
  - OpenMP 라이브러리 내부의 병렬화 메커니즘을 수정하여, 병렬 영역 실행과 프로파일링을 하나로 묶어 수행합니다.
  - 프로파일링은 PCM(un-core 메모리 대역폭 측정) 및 perf_event_open(명령어, 사이클, 캐시 참조/미스, FP 연산 이벤트 측정)을 사용합니다.
  - 초기화 시, 현재 프로세스가 GSCHED 데몬인지 일반 프로그램인지 판별하여, GSCHED 에 초기 일반 프로세스 정보 전송을 위한 통신과 실행 중 프로파일링 및 스케줄링을 위한 GSCHED와의 전용 통신을 구성합니다.
  - GSCHED와의 IPC는 메시지 큐를 통해 이루어지며, 각 후보 구성의 프로파일링 결과가 GSCHED에 전송되고, GSCHED로부터 최종 스케줄링 결정(최종 스레드 수)이 수신됩니다.

## 주요 기능

- **프로파일링 통합:**  
  - `profile_parallel_region()` 함수는 후보 스레드 수에 대해 `gomp_team_start()`와 `fn(data)`를 묶어 한 번에 실행하면서 성능 지표(throughput, FLOPS, cache miss rate, 메모리 대역폭)를 측정합니다.
  - 측정된 데이터는 GSCHED에 전송되어, 최종 스케줄링 결정을 내리는 데 활용됩니다.

- **동적 스케줄링:**  
  - GSCHED 데몬은 수신된 프로파일링 데이터를 기반으로 전체 시스템의 최적 스케줄링 조합(각 태스크의 최적 스레드 개수 및 코어 배치)을 결정하고, 이 결정 정보를 각 태스크의 MQ로 전달합니다.
  - OpenMP 라이브러리에서는 GSCHED로부터 최종 결정된 스레드 수로 병렬 영역을 다시 실행합니다.

## 요구 사항

- **운영체제:** Linux (mqueue, perf_event, PCM 지원)
- **컴파일러:** GCC (수정된 OpenMP 라이브러리)
- **라이브러리:**  
  - Intel PCM (cpucounters, utils, types)
  - Linux perf_event API
- **빌드 환경:** GNU make 또는 CMake

## 빌드 및 적용 방법

1. **컴파일:**  
   - 수정된 libgomp 소스를 빌드하여, 수정된 라이브러리를 생성합니다.
   - 필요한 PCM 및 perf 관련 헤더와 라이브러리가 포함되어 있어야 합니다.

2. **링크:**  
   - 사용자 애플리케이션은 수정된 OpenMP 라이브러리와 함께 링크하여 실행합니다.
   - 애플리케이션은 기존의 `#pragma omp parallel` 구문을 사용하여 병렬 영역을 구현하면, 내부적으로 수정된 Adaptive OpenMP의 `GOMP_parallel` 함수가 호출됩니다.

3. **환경 변수 설정:**  
   - GSCHED 데몬과 일반 애플리케이션을 구분하기 위해, 예를 들어 `IS_GSCHED=1`과 같은 환경 변수를 설정합니다.

4. **GSCHED 데몬 실행:**  
   - GSCHED 데몬은 별도 실행 파일로 구현되며, 수정된 OpenMP 라이브러리와 메시지 큐(MQ)를 통해 통신합니다.
   - GSCHED 데몬은 각 태스크의 MQ를 생성하고, 프로파일링 데이터를 수신하여 최적 스케줄링 결정을 내립니다.


## 라이센스

이 프로젝트는 GCC OpenMP 라이브러리(GPLv3 라이센스)를 기반으로 하여 수정되었습니다.  
수정된 소스코드는 동일한 GPLv3 라이센스 하에 배포됩니다.

## 참고 자료

- [Intel PCM](https://github.com/opcm/pcm)
- Linux perf_event_open 매뉴얼
- GCC OpenMP 라이브러리(libgomp) 소스코드

---
